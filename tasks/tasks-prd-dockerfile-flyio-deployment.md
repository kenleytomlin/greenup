# Tasks: Configure Dockerfile and Deployment Pipeline for Fly.io

Based on PRD: `prd-dockerfile-flyio-deployment.md`

## Relevant Files

- `Dockerfile` - Multi-stage Docker configuration for Elixir Phoenix application deployment (generated by fly launch).
- `fly.toml` - Fly.io deployment configuration with resource allocation and service settings (generated by fly launch).
- `.dockerignore` - Docker ignore file to exclude unnecessary files from build context (generated by fly launch).
- `rel/env.sh.eex` - Release environment configuration for distributed Elixir support (generated by fly launch).
- `config/prod.exs` - Phoenix production configuration that may need updates for Fly.io deployment.
- `config/runtime.exs` - Runtime configuration for environment variables and database connections.
- `rel/overlays/bin/migrate` - Database migration script for deployment (if needed).
- `lib/greenup_web/endpoint.ex` - Phoenix endpoint configuration that may need production updates.
- `mix.exs` - Project dependencies and release configuration.

### Notes

- **IMPORTANT**: `flyctl` can automatically bootstrap both Dockerfile and fly.toml using `fly launch` command
- The `fly launch` command detects Phoenix apps and runs `mix phx.gen.release --docker` automatically
- Manual configuration may still be needed for specific requirements (hexpm/build images, resource allocation)
- Use Fly.io's internal networking for database connections via the Postgres addon
- Environment variables and secrets should be managed through Fly.io's secrets system
- WebSocket support must be properly configured for Phoenix LiveView functionality
- Use `fly deploy` command for manual deployment after configuration is complete

## Tasks

- [ ] 0.0 **Quick Start Option**: Use `fly launch` to auto-generate both Dockerfile and fly.toml
  - [x] 0.1 Install flyctl CLI tool
  - [x] 0.2 Run `fly launch` in the Phoenix project directory 
  - [x] 0.3 Choose not to deploy initially (select "No" when prompted)
  - [x] 0.4 Review and customize the generated Dockerfile and fly.toml files
  - [x] 0.5 Proceed to testing tasks (4.0) if satisfied with auto-generated files
- [ ] 1.0 Create optimized Dockerfile with multi-stage build
  - [ ] 1.1 **Option A**: Run `fly launch` to auto-generate Dockerfile and fly.toml, then customize as needed
  - [ ] 1.2 **Option B**: Manual setup - Set up multi-stage build using hexpm/build:1.18.4-erlang-28.0.1-debian-bullseye-20241111 for compilation stage
  - [ ] 1.3 Configure build stage with Mix dependencies installation and asset compilation  
  - [ ] 1.4 Create minimal runtime stage using hexpm/elixir:1.18.4-erlang-28.0.1-debian-bullseye-20241111-slim
  - [ ] 1.5 Install runtime dependencies using apt (postgresql-client, ca-certificates, curl for health checks)
  - [ ] 1.6 Configure non-root user for security and proper file permissions
  - [ ] 1.7 Set EXPOSE port 4000 and configure proper entrypoint for Phoenix releases
- [ ] 2.0 Generate fly.toml configuration for Fly.io deployment
  - [ ] 2.1 **Option A**: Use fly.toml generated by `fly launch` command, then customize resource allocation  
  - [ ] 2.2 **Option B**: Manual setup - Initialize fly.toml with basic app configuration and shared-cpu-1x instance type
  - [ ] 2.3 Configure resource allocation with 1GB RAM and appropriate CPU settings
  - [ ] 2.4 Set up HTTP service configuration with port 4000 and WebSocket support
  - [ ] 2.5 Enable HTTPS termination with automatic SSL certificate management
  - [ ] 2.6 Configure health check endpoint for application monitoring
  - [ ] 2.7 Set up environment variables structure for database and secrets management
  - [ ] 2.8 Configure database connection settings for Fly.io Postgres addon integration
- [ ] 3.0 Configure Phoenix application for production deployment
  - [ ] 3.1 Update config/prod.exs for production release mode and Fly.io environment
  - [ ] 3.2 Configure config/runtime.exs for database connection pooling and environment variables
  - [ ] 3.3 Enable WebSocket support and configure endpoint for Phoenix LiveView
  - [ ] 3.4 Set up SSL/TLS configuration for external API connections (Smarkets)
  - [ ] 3.5 Configure logging settings appropriate for Fly.io log aggregation
  - [ ] 3.6 Update mix.exs release configuration if needed for production deployment
- [ ] 4.0 Test and validate deployment configuration
  - [ ] 4.1 Build Docker image locally and verify multi-stage build optimization
  - [ ] 4.2 Test Phoenix application starts correctly in containerized environment
  - [ ] 4.3 Validate WebSocket connections work properly (Phoenix LiveView)
  - [ ] 4.4 Deploy to Fly.io and verify application functionality
  - [ ] 4.5 Test database connectivity and connection pooling
  - [ ] 4.6 Verify resource usage meets 1GB RAM constraint and performance requirements 